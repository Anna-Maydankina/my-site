{% extends 'base.html' %}
{% load static %}

{% block content %}

<section class="py-3 py-md-5 mobile-padding">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-12 col-md-10">
                <!-- –ì–µ—Ä–æ-—Å–µ–∫—Ü–∏—è -->
                <div class="text-center mb-5 hero-section">
                    <h1 class="h2 mb-3">–§–∞–Ω—Ñ–∏—Ç–∞—Å—Ç–∏–∫–∞</h1>
                    <p class="mb-4">
                        –°–∞–π—Ç —Å –∏—Å—Ç–æ—Ä–∏—è–º–∏ –ø–æ –ª—é–±–∏–º—ã–º –∏ –∞–≤—Ç–æ—Ä—Å–∫–∏–º –≤—Å–µ–ª–µ–Ω–Ω—ã–º
                    </p>
                    
                    <!-- –§–û–†–ú–ê –ë–´–°–¢–†–û–ì–û –ü–û–ò–°–ö–ê -->
                    <form method="get" action="{% url 'advanced_search' %}" class="quick-search-form">
                        <div class="row g-2 justify-content-center">
                            <div class="col-12 col-sm-8">
                                <input type="text" 
                                       name="title" 
                                       class="form-control form-control-sm search-input" 
                                       placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ñ–∞–Ω—Ñ–∏–∫–∞..."
                                       value="">
                            </div>
                            <div class="col-12 col-sm-auto">
                                <button class="btn btn-sm w-100 search-btn" type="submit">
                                    –ù–∞–π—Ç–∏
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- === –ü–û–ü–£–õ–Ø–†–ù–´–ï –§–ê–ù–§–ò–ö–ò === -->
                <div class="stories-selection">
                    <h2 class="selection-title">üî• –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏</h2>
                    <div class="stories-scroll-container">
                        <button class="scroll-btn scroll-btn-prev" data-target="popular-scroll">‚ùÆ</button>
                        <button class="scroll-btn scroll-btn-next" data-target="popular-scroll">‚ùØ</button>
                        
                        <div class="stories-scroll" id="popular-scroll">
                            {% for fanfic in popular_fanfics %}
                            <div class="story-card">
                                <h3 class="story-title">{{ fanfic.title|truncatechars:50 }}</h3>
                                <div class="story-author">–ê–≤—Ç–æ—Ä: {{ fanfic.author.username }}</div>
                                <div class="story-stats">
                                    <span class="stat-item">
                                        <i class="fas fa-eye"></i> {{ fanfic.views_count }}
                                    </span>
                                    {% if fanfic.get_comments_count > 0 %}
                                    <span class="stat-item">
                                        <i class="fas fa-comment"></i> {{ fanfic.get_comments_count }}
                                    </span>
                                    {% endif %}
                                </div>
                                {% if fanfic.description %}
                                <p class="story-description">{{ fanfic.description|truncatechars:150 }}</p>
                                {% else %}
                                <p class="story-description no-description">–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>
                                {% endif %}
                                <div class="story-tags">
                                    {% for tag in fanfic.get_tags_list|slice:":3" %}
                                        {% if tag and tag.strip %}
                                            {% with tag_slug=tag|slugify %}
                                                {% if tag_slug %}
                                                    <a href="{% url 'tag_detail' tag_slug %}" class="tag">{{ tag|truncatechars:15 }}</a>
                                                {% else %}
                                                    <span class="tag">{{ tag|truncatechars:15 }}</span>
                                                {% endif %}
                                            {% endwith %}
                                        {% endif %}
                                    {% empty %}
                                    <span class="tag no-tags">–±–µ–∑ —Ç–µ–≥–æ–≤</span>
                                    {% endfor %}
                                </div>
                                <div class="story-footer">
                                    <small class="story-date">
                                        <i class="far fa-calendar me-1"></i> {{ fanfic.created_at|date:"d.m.Y" }}
                                    </small>
                                    <a href="{% url 'fanfic_detail' fanfic.pk %}" class="btn-read">–ß–∏—Ç–∞—Ç—å</a>
                                </div>
                            </div>
                            {% empty %}
                            <div class="story-card empty-card">
                                <h3 class="story-title">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏–π</h3>
                                <p class="story-description">–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º–∏, –∫—Ç–æ —Å–æ–∑–¥–∞—Å—Ç –ø–æ–ø—É–ª—è—Ä–Ω—ã–π —Ñ–∞–Ω—Ñ–∏–∫!</p>
                                <div class="story-footer">
                                    <a href="{% url 'fanfic_create' %}" class="btn-read">–°–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é</a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- === –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò === -->
                <div class="stories-selection">
                    <h2 class="selection-title">üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤–∞—Å</h2>
                    <div class="stories-scroll-container">
                        <button class="scroll-btn scroll-btn-prev" data-target="recommended-scroll">‚ùÆ</button>
                        <button class="scroll-btn scroll-btn-next" data-target="recommended-scroll">‚ùØ</button>
                        
                        <div class="stories-scroll" id="recommended-scroll">
                            {% for fanfic in recommended_fanfics|slice:":10" %}
                            <div class="story-card">
                                <h3 class="story-title">{{ fanfic.title|truncatechars:50 }}</h3>
                                <div class="story-author">–ê–≤—Ç–æ—Ä: {{ fanfic.author.username }}</div>
                                <div class="story-stats">
                                    <span class="stat-item">
                                        <i class="fas fa-fire"></i> –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ
                                    </span>
                                    {% if fanfic.views_count > 0 %}
                                    <span class="stat-item">
                                        <i class="fas fa-eye"></i> {{ fanfic.views_count }}
                                    </span>
                                    {% endif %}
                                </div>
                                {% if fanfic.description %}
                                <p class="story-description">{{ fanfic.description|truncatechars:150 }}</p>
                                {% else %}
                                <p class="story-description no-description">–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>
                                {% endif %}
                                <div class="story-tags">
                                    {% for tag in fanfic.get_tags_list|slice:":3" %}
                                        {% if tag and tag.strip %}
                                            {% with tag_slug=tag|slugify %}
                                                {% if tag_slug %}
                                                    <a href="{% url 'tag_detail' tag_slug %}" class="tag">{{ tag|truncatechars:15 }}</a>
                                                {% else %}
                                                    <span class="tag">{{ tag|truncatechars:15 }}</span>
                                                {% endif %}
                                            {% endwith %}
                                        {% endif %}
                                    {% empty %}
                                    <span class="tag no-tags">–±–µ–∑ —Ç–µ–≥–æ–≤</span>
                                    {% endfor %}
                                </div>
                                <div class="story-footer">
                                    <small class="story-date">
                                        <i class="far fa-calendar me-1"></i> {{ fanfic.created_at|date:"d.m.Y" }}
                                    </small>
                                    <a href="{% url 'fanfic_detail' fanfic.pk %}" class="btn-read">–ß–∏—Ç–∞—Ç—å</a>
                                </div>
                            </div>
                            {% empty %}
                            <div class="story-card empty-card">
                                <h3 class="story-title">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3>
                                <p class="story-description">–ù–∞—á–Ω–∏—Ç–µ —á–∏—Ç–∞—Ç—å —Ñ–∞–Ω—Ñ–∏–∫–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏!</p>
                                <div class="story-footer">
                                    <a href="{% url 'new_fanfics' %}" class="btn-read">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–æ–≤—ã–µ</a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- === –ù–û–í–´–ï –§–ê–ù–§–ò–ö–ò === -->
                <div class="stories-selection">
                    <h2 class="selection-title">‚ú® –ù–æ–≤–∏–Ω–∫–∏</h2>
                    <div class="stories-scroll-container">
                        <button class="scroll-btn scroll-btn-prev" data-target="new-scroll">‚ùÆ</button>
                        <button class="scroll-btn scroll-btn-next" data-target="new-scroll">‚ùØ</button>
                        
                        <div class="stories-scroll" id="new-scroll">
                            {% for fanfic in new_fanfics|slice:":10" %}
                            <div class="story-card">
                                <h3 class="story-title">{{ fanfic.title|truncatechars:50 }}</h3>
                                <div class="story-author">–ê–≤—Ç–æ—Ä: {{ fanfic.author.username }}</div>
                                <div class="story-stats">
                                    <span class="stat-item">
                                        <i class="fas fa-star"></i> –ù–æ–≤–æ–µ
                                    </span>
                                    <span class="stat-item">
                                        <i class="far fa-calendar"></i> {{ fanfic.created_at|date:"d.m.Y" }}
                                    </span>
                                </div>
                                {% if fanfic.description %}
                                <p class="story-description">{{ fanfic.description|truncatechars:150 }}</p>
                                {% else %}
                                <p class="story-description no-description">–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>
                                {% endif %}
                                <div class="story-tags">
                                    {% for tag in fanfic.get_tags_list|slice:":3" %}
                                        {% if tag and tag.strip %}
                                            {% with tag_slug=tag|slugify %}
                                                {% if tag_slug %}
                                                    <a href="{% url 'tag_detail' tag_slug %}" class="tag">{{ tag|truncatechars:15 }}</a>
                                                {% else %}
                                                    <span class="tag">{{ tag|truncatechars:15 }}</span>
                                                {% endif %}
                                            {% endwith %}
                                        {% endif %}
                                    {% empty %}
                                    <span class="tag no-tags">–±–µ–∑ —Ç–µ–≥–æ–≤</span>
                                    {% endfor %}
                                </div>
                                <div class="story-footer">
                                    <small class="story-date">
                                        <i class="far fa-calendar me-1"></i> {{ fanfic.created_at|date:"d.m.Y" }}
                                    </small>
                                    <a href="{% url 'fanfic_detail' fanfic.pk %}" class="btn-read">–ß–∏—Ç–∞—Ç—å</a>
                                </div>
                            </div>
                            {% empty %}
                            <div class="story-card empty-card">
                                <h3 class="story-title">–ü–æ–∫–∞ –Ω–µ—Ç –Ω–æ–≤—ã—Ö –∏—Å—Ç–æ—Ä–∏–π</h3>
                                <p class="story-description">–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –æ–ø—É–±–ª–∏–∫—É–µ—Ç –Ω–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é!</p>
                                <div class="story-footer">
                                    <a href="{% url 'fanfic_create' %}" class="btn-read">–°–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é</a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</section>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sections = [
        { id: 'popular-scroll' },
        { id: 'recommended-scroll' },
        { id: 'new-scroll' }
    ];

    sections.forEach(section => {
        const scrollContainer = document.getElementById(section.id);
        if (!scrollContainer) return;
        
        const container = scrollContainer.parentElement;
        const prevBtn = container.querySelector('.scroll-btn-prev');
        const nextBtn = container.querySelector('.scroll-btn-next');
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∫—Ä–æ–ª–ª–∞
        function checkScrollable() {
            const maxScroll = scrollContainer.scrollWidth - scrollContainer.clientWidth;
            const currentScroll = scrollContainer.scrollLeft;
            
            if (prevBtn) {
                prevBtn.style.opacity = currentScroll > 0 ? '1' : '0.3';
                prevBtn.disabled = currentScroll <= 0;
            }
            
            if (nextBtn) {
                nextBtn.style.opacity = currentScroll < maxScroll - 10 ? '1' : '0.3';
                nextBtn.disabled = currentScroll >= maxScroll - 10;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –Ω–∞ 2 –∫–∞—Ä—Ç–æ—á–∫–∏
        function scrollCards(direction) {
            const cardWidth = scrollContainer.querySelector('.story-card')?.offsetWidth || 300;
            const gap = 15;
            const scrollAmount = (cardWidth + gap) * 2;
            
            scrollContainer.scrollBy({
                left: direction === 'next' ? scrollAmount : -scrollAmount,
                behavior: 'smooth'
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø–æ—Å–ª–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
            setTimeout(checkScrollable, 300);
        }
        
        // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏
        if (prevBtn) {
            prevBtn.addEventListener('click', () => scrollCards('prev'));
        }
        
        if (nextBtn) {
            nextBtn.addEventListener('click', () => scrollCards('next'));
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        scrollContainer.addEventListener('scroll', checkScrollable);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', checkScrollable);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
        checkScrollable();
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –µ—Å–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–º–µ—â–∞—é—Ç—Å—è
        function updateButtonVisibility() {
            const maxScroll = scrollContainer.scrollWidth - scrollContainer.clientWidth;
            if (maxScroll <= 10) {
                if (prevBtn) prevBtn.style.display = 'none';
                if (nextBtn) nextBtn.style.display = 'none';
            } else {
                if (prevBtn) prevBtn.style.display = 'flex';
                if (nextBtn) nextBtn.style.display = 'flex';
            }
        }
        
        updateButtonVisibility();
        window.addEventListener('resize', updateButtonVisibility);
    });
});
</script>
{% endblock %}